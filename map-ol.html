<!DOCTYPE html>
<html>
	<meta charset="UTF-8">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js" integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.min.js" integrity="sha512-vs7+jbztHoMto5Yd/yinM4/y2DOkPLt0fATcN+j+G4ANY2z4faIzZIOMkpBmWdcxt+596FemCh9M18NUJTZwvw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/ol-mapbox-style@12.1.1/dist/olms.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">

<script> 
$(document).ready(() => {

	// 			source: new ol.source.OSM(),
	console.log("osm",new ol.source.OSM());

	var map = new ol.Map({
		target: 'map',
		layers: [
		],
		view: new ol.View({
			center: ol.proj.fromLonLat([173, -44]),
			zoom: 10,
		}),
	});
	window.map = map;
	
	// Create a vector source and layer
				var vectorSource = new ol.source.Vector();
				var vectorLayer = new ol.layer.Vector({
					source: vectorSource,
				});

				map.addLayer(vectorLayer);

				// Function to update data based on the current viewport
        function updateData() {
          // Get the bounding box from the current viewport
          var extent = map.getView().calculateExtent(map.getSize());
          var boundingBox = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
		  
		  var lat_min = boundingBox[1];
		  var lat_max = boundingBox[3];
		  var long_min = boundingBox[0];
		  var long_max = boundingBox[2];
		  
		  debugger;
		  
		  if (lat_max < lat_min) {
			lat_min = boundingBox[3];
			lat_max = boundingBox[1];
		  }
		  if (long_max <  long_min) {
			long_min = boundingBox[2];
			long_max = boundingBox[0];
		  }

          // Use Overpass API to fetch data
          var overpassUrl = 'https://overpass-api.de/api/interpreter';
          var overpassQuery = '[out:json];way["route"="mtb"](bbox:' +
                    lat_min + ',' + long_min + ',' +
                    lat_max + ',' + long_max +
                    ');out body;';
	
		console.log("Query", overpassQuery);
          $.ajax({
            method: 'POST',
            url: overpassUrl,
            data: {
              data: overpassQuery,
            },
            success: function (data) {
				console.log("overpass", data);

              // Clear previous features
              vectorSource.clear();

              // Process Overpass API response and create features
              var features = new ol.format.GeoJSON().readFeatures(data);
              vectorSource.addFeatures(features);
            },
			error: function (data) {
				console.log("op error", data);
			},
          });
        }

        // Add an event listener for map view changes
        map.on('moveend', updateData);

        // Initial data update
        updateData();

	setTimeout(() => {
		olms.apply(map, 'cycleosm.json').then(function () {
	 		// Map has been successfully styled with Mapbox style
		});
	},500);
});
</script>

	
	<body>
	<div><span>test</span></div>
	<div id="map" style="width: 100%; height: calc(100vh - 90px);"></div>
</body>
</html>